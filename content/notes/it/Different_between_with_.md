---
title: "制作启动盘的时候一些坑"
category: "IT"
tags: ["Stupid"]
date: "2025-11-09"
---

在制作启动盘的时候，每次都会碰到结尾为img和iso的镜像文件，之前由于制作的Linux启动盘比较多，所以一半直接用Win32 Disk Imager写入到U盘或者sd卡中，也能使用。但是今天制作Windows的启动盘的时候，出现了一些小问题。我使用Win32 Disk Imager写入U盘后，发现U盘没有分区，并且插入新电脑后也没有引导成功。之前没有关注过这个问题，今天碰到了就总结一下这个问题。

## 启动盘原理
复习一下计算机组成原理，在电脑开机后，系统分别做了以下的事情
1. CPU上电后，ROM BISO的代码映射到内存中的0xFFFF0处，此时，内存中有了BISO固件的代码，这被称为ROM BIOS代码映射区。
2. PC指针指向0xFFFF0的ROM BIOS代码映射区，开始顺序执行该代码区域，该代码包含了检查内存，键盘等设备是否能够正常工作，若不能，计算机会发生警报，无法开机。
3. 将硬盘中的0磁道0扇区的内容读入到0x7c00区域，就是把boot模块读入到了内存的0x7c00区域，然后将PC指针指向该地址。

那么如何来判断0x7c00的扇区内容，需要有什么特定格式吗？有的，兄弟，包有的。

首先内含三部分：
* 前446字节：引导代码（boot code）。
* 后面64字节：分区表（4个主分区）。
* 最后两个字节：0x55AA签名。

其中的4个主分区，需要有一个“活动分区”（active/bootable）
* 分区表里的某一项需要被标记为active（通过分区表的第一个字节来判断，0x80就是活动分区）。
* BIOS的MBR引导代码回去这个活动分区引导扇区继续执行。
  
后续的流程就是从这个分区里运行bootloader。
例如：
* Windows：bootmgr + BCD
* Linux：GRUB/syslinux 等。

当然，现在还有更新的启动方式，就是UEFI了。
UEFI 不使用 512 字节的扇区跳转，走的是“文件级协议”。

他由下面几个Part组成
1. EFI System Partition（ESP）：
   * 一般是FAT32
   * 或者是MBR or GPT，一般是GPT + 一个标记的ESP的分区。
2. ESP里有标准的EFI文件
   * 通用默认路径：/EFI/BOOT/BOOTX64.EFI（x86_64）

3. UEFI 固件：
   * 扫描盘 → 找 ESP → 找 .efi 引导文件 → 直接执行。
   * 这个 .efi 引导程序再去加载内核/安装程序等。


OK，启动U盘包含什么就清楚了。
* 正确的 MBR/GPT + 分区表；
* 必要的 引导扇区 / EFI 分区；
* 对应的 引导程序文件（bootloader）；
* 系统安装文件或 PE 系统本体。
一个可以正确使用的启动盘需要保证以上内容的完整。

为啥有的时候把 ISO 写进 U 盘可以，有时不行

现在结果已经很清楚了

* 部分 Linux ISO 是 **Hybrid ISO**：

  * 里面已经内置了适用于 U 盘的 MBR/分区表/ESP。
  * 用 Win32 Disk Imager / `dd` 直接写入：

    * 扇区结构对就能启动成功了。

* Windows 原版 ISO：

  * 面向光盘（ISO9660 + El Torito），**没有为 U 盘准备完整的磁盘结构**。
  * 用 Win32 Disk Imager 生硬写入：

    * 对 UEFI：看不到正确 ESP；
    * 对 BIOS：MBR/active 分区不对；
    * 结果：**不认、不启动**。


